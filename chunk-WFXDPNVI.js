import{a as fe,b as ge}from"./chunk-SCFAFR5F.js";import{a as ce,d as me,g as pe,h as de,i as ue}from"./chunk-DZWPVE7X.js";import{c as W}from"./chunk-ZQOI7BBG.js";import{c as he}from"./chunk-PNK3MDVW.js";import{a as be,b as _e}from"./chunk-KVGMTMPN.js";import{b as ee,c as te,e as ie,f as re,j as oe,l as ne,m as ae,o as se,q as le}from"./chunk-GJAULJBT.js";import{a as J,d as Q}from"./chunk-K3W4U4ZG.js";import"./chunk-KW5VBN5V.js";import{U as X,V as Z,a as E}from"./chunk-PT23TE2W.js";import"./chunk-Q64FFBLU.js";import{D as h,F,Hb as s,Ib as w,J as $,Jb as N,Kb as R,O as I,Pb as Y,Qa as q,R as T,Ta as l,Ua as k,V as C,_ as x,d as G,da as _,ha as V,ib as v,j as P,kb as p,lc as z,mc as K,n as f,pa as j,qa as U,qb as a,qc as H,r as y,rb as n,sb as L,ub as D,xb as B,z as S,zb as g}from"./chunk-HBN3XZPF.js";var A={production:!1,googleBooksApiUrl:"https://www.googleapis.com/books/v1",openLibraryApiUrl:"https://openlibrary.org"};var ve=(()=>{class r{constructor(e){this.http=e,this.apiUrl=`${A.googleBooksApiUrl}/volumes`}search(e,t,i=20,o=0){let m=e;t&&(m+=`+inauthor:${t}`);let d={q:m,maxResults:i.toString(),startIndex:o.toString(),projection:"full"};return this.http.get(this.apiUrl,{params:d}).pipe(y(c=>!c.items||c.items.length===0?[]:c.items.map(b=>this.mapToBook(b))),h(c=>(console.error("Google Books API error:",c),f([]))))}searchByIsbn(e){let t={q:`isbn:${e}`,maxResults:"1",projection:"full"};return this.http.get(this.apiUrl,{params:t}).pipe(y(i=>!i.items||i.items.length===0?[]:i.items.map(o=>this.mapToBook(o))),h(i=>(console.error("Google Books API error:",i),f([]))))}mapToBook(e){let t=e.volumeInfo,i=this.extractIsbn(t.industryIdentifiers),o=t.publishedDate?parseInt(t.publishedDate.substring(0,4),10):null,m=t.dimensions?{height:this.parseDimension(t.dimensions.height),width:this.parseDimension(t.dimensions.width),thickness:this.parseDimension(t.dimensions.thickness)}:null,d=t.imageLinks?.thumbnail||t.imageLinks?.smallThumbnail||null;return{isbn:i||`GOOGLE-${e.id}`,title:t.title,author:t.authors?t.authors.join(", "):"Unknown Author",publicationYear:o,pageCount:t.pageCount||null,dimensions:m,coverImageUrl:d,description:t.description||null,googleBooksId:e.id,openLibraryKey:null,source:"google-books",addedAt:new Date}}extractIsbn(e){if(!e||e.length===0)return null;let t=e.find(o=>o.type==="ISBN_13");if(t)return t.identifier;let i=e.find(o=>o.type==="ISBN_10");return i?i.identifier:e[0]?.identifier||null}parseDimension(e){if(!e)return null;let t=e.match(/^([\d.]+)/);return t?parseFloat(t[1]):null}static{this.\u0275fac=function(t){return new(t||r)(_(E))}}static{this.\u0275prov=x({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var ye=(()=>{class r{constructor(e){this.http=e,this.apiUrl=`${A.openLibraryApiUrl}/search.json`,this.coverUrl="https://covers.openlibrary.org/b/id"}search(e,t,i=20,o=0){let m=e;t&&(m+=` author:${t}`);let d={q:m,limit:i.toString(),offset:o.toString(),fields:"key,title,author_name,first_publish_year,isbn,number_of_pages_median,cover_i"};return this.http.get(this.apiUrl,{params:d}).pipe(y(c=>!c.docs||c.docs.length===0?[]:c.docs.map(b=>this.mapToBook(b))),h(c=>(console.error("Open Library API error:",c),f([]))))}searchByIsbn(e){let t={q:`isbn:${e}`,limit:"1",fields:"key,title,author_name,first_publish_year,isbn,number_of_pages_median,cover_i"};return this.http.get(this.apiUrl,{params:t}).pipe(y(i=>!i.docs||i.docs.length===0?[]:i.docs.map(o=>this.mapToBook(o))),h(i=>(console.error("Open Library API error:",i),f([]))))}mapToBook(e){let t=this.extractIsbn(e.isbn),i=e.cover_i?`${this.coverUrl}/${e.cover_i}-L.jpg`:null;return{isbn:t||`OPENLIBRARY-${e.key}`,title:e.title,author:e.author_name?e.author_name.join(", "):"Unknown Author",publicationYear:e.first_publish_year||null,pageCount:e.number_of_pages_median||null,dimensions:null,coverImageUrl:i,description:null,googleBooksId:null,openLibraryKey:e.key,source:"open-library",addedAt:new Date}}extractIsbn(e){if(!e||e.length===0)return null;let t=e.find(i=>i.startsWith("978")||i.startsWith("979"));return t||e[0]||null}static{this.\u0275fac=function(t){return new(t||r)(_(E))}}static{this.\u0275prov=x({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var xe=(()=>{class r{constructor(e,t){this.googleBooksApi=e,this.openLibraryApi=t,this.searchCache=new Map}search(e,t,i=20,o=0){let m=`${e}-${t||""}-${i}-${o}`;if(this.searchCache.has(m))return this.searchCache.get(m);let d=this.googleBooksApi.search(e,t,i,o).pipe(I({count:3,delay:(c,b)=>{let M=Math.pow(2,b-1)*1e3;return console.warn(`Retry attempt ${b} after ${M}ms`,c),S(M)}}),h(c=>(console.warn("Google Books failed after retries, trying Open Library",c),this.openLibraryApi.search(e,t,i,o).pipe(I({count:3,delay:(b,M)=>{let ke=Math.pow(2,M-1)*1e3;return S(ke)}})))),h(c=>(console.error("Both APIs failed after retries",c),f([]))),T(1));return this.searchCache.set(m,d),setTimeout(()=>{this.searchCache.delete(m)},5*60*1e3),d}searchByIsbn(e){let t=`isbn-${e}`;if(this.searchCache.has(t))return this.searchCache.get(t);let i=this.googleBooksApi.searchByIsbn(e).pipe(I({count:3,delay:(o,m)=>{let d=Math.pow(2,m-1)*1e3;return S(d)}}),h(o=>(console.warn("Google Books failed, trying Open Library",o),this.openLibraryApi.searchByIsbn(e).pipe(I({count:3,delay:(m,d)=>{let c=Math.pow(2,d-1)*1e3;return S(c)}})))),h(o=>(console.error("Both APIs failed",o),f([]))),T(1));return this.searchCache.set(t,i),setTimeout(()=>{this.searchCache.delete(t)},5*60*1e3),i}clearCache(){this.searchCache.clear()}static{this.\u0275fac=function(t){return new(t||r)(_(ve),_(ye))}}static{this.\u0275prov=x({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();function Be(r,u){r&1&&L(0,"app-loading-spinner")}function Me(r,u){r&1&&(a(0,"div",14)(1,"mat-icon",15),s(2,"search_off"),n(),a(3,"h2",16),s(4,"No books found"),n(),a(5,"p",17),s(6,"Try adjusting your search terms"),n(),a(7,"button",18)(8,"mat-icon"),s(9,"add"),n(),s(10," Add Book Manually "),n()())}function we(r,u){if(r&1&&(a(0,"span"),s(1),n()),r&2){let e=g().$implicit;l(),w(e.publicationYear)}}function Ee(r,u){if(r&1&&(a(0,"span"),s(1),n()),r&2){let e=g().$implicit;l(),N(" \u2022 ",e.pageCount," pages")}}function Ae(r,u){if(r&1){let e=D();a(0,"div",22),L(1,"img",23),a(2,"h3",24),s(3),n(),a(4,"p",25),s(5),n(),a(6,"p",26),v(7,we,2,1,"span",12)(8,Ee,2,1,"span",12),n(),a(9,"button",27),B("click",function(){let i=j(e).$implicit,o=g(3);return U(o.addToLibrary(i))}),a(10,"mat-icon"),s(11,"add"),n(),s(12," Add to Library "),n()()}if(r&2){let e=u.$implicit;l(),p("src",e.coverImageUrl||"assets/placeholder-book.png",q)("alt",e.title),l(2),w(e.title),l(2),w(e.author),l(2),p("ngIf",e.publicationYear),l(),p("ngIf",e.pageCount)}}function Fe(r,u){r&1&&(a(0,"mat-icon"),s(1,"expand_more"),n())}function $e(r,u){if(r&1){let e=D();a(0,"div",28)(1,"button",29),B("click",function(){j(e);let i=g(3);return U(i.loadMore())}),v(2,Fe,2,0,"mat-icon",12),s(3),n()()}if(r&2){let e=g(3);l(),p("disabled",e.isLoading),l(),p("ngIf",!e.isLoading),l(),N(" ",e.isLoading?"Loading...":"Load More"," ")}}function Te(r,u){if(r&1&&(a(0,"div")(1,"p",17),s(2),n(),a(3,"div",19),v(4,Ae,13,6,"div",20),n(),v(5,$e,4,3,"div",21),n()),r&2){let e=g(2);l(2),R("Found ",e.books.length," result",e.books.length!==1?"s":"",""),l(2),p("ngForOf",e.books),l(),p("ngIf",e.canLoadMore)}}function je(r,u){if(r&1&&(a(0,"div"),v(1,Me,11,0,"div",13)(2,Te,6,4,"div",12),n()),r&2){let e=g();l(),p("ngIf",e.books.length===0),l(),p("ngIf",e.books.length>0)}}var at=(()=>{class r{constructor(e,t,i,o,m){this.fb=e,this.bookApi=t,this.readingLog=i,this.snackBar=o,this.router=m,this.books=[],this.isLoading=!1,this.hasSearched=!1,this.currentStartIndex=0,this.canLoadMore=!1,this.destroy$=new P,this.searchForm=this.fb.group({title:["",te.required],author:[""]})}ngOnInit(){this.searchForm.get("title")?.valueChanges.pipe(F(500),$(),C(this.destroy$)).subscribe(()=>{this.searchForm.get("title")?.value?.trim()&&this.performSearch()}),this.searchForm.get("author")?.valueChanges.pipe(F(500),$(),C(this.destroy$)).subscribe(()=>{this.searchForm.get("title")?.value?.trim()&&this.performSearch()})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}performSearch(){let e=this.searchForm.get("title")?.value?.trim();if(!e)return;let t=this.searchForm.get("author")?.value?.trim();this.isLoading=!0,this.currentStartIndex=0,this.hasSearched=!0,this.bookApi.search(e,t,20,0).pipe(C(this.destroy$)).subscribe({next:i=>{this.books=i,this.canLoadMore=i.length===20,this.isLoading=!1},error:i=>{console.error("Search error:",i),this.books=[],this.canLoadMore=!1,this.isLoading=!1}})}loadMore(){let e=this.searchForm.get("title")?.value?.trim();if(!e||this.isLoading)return;let t=this.searchForm.get("author")?.value?.trim();this.currentStartIndex+=20,this.isLoading=!0,this.bookApi.search(e,t,20,this.currentStartIndex).pipe(C(this.destroy$)).subscribe({next:i=>{this.books=[...this.books,...i],this.canLoadMore=i.length===20,this.isLoading=!1},error:i=>{console.error("Load more error:",i),this.canLoadMore=!1,this.isLoading=!1}})}clearSearch(){this.searchForm.reset(),this.books=[],this.hasSearched=!1,this.currentStartIndex=0,this.canLoadMore=!1}addToLibrary(e){return G(this,null,function*(){try{yield this.readingLog.addBook(e),this.snackBar.open(`"${e.title}" added to your library!`,"View Library",{duration:5e3,horizontalPosition:"center",verticalPosition:"bottom"}).onAction().subscribe(()=>{this.router.navigate(["/library"])})}catch(t){let i=t.message||"Failed to add book to library";this.snackBar.open(i,"Close",{duration:5e3,horizontalPosition:"center",verticalPosition:"bottom",panelClass:["error-snackbar"]})}})}static{this.\u0275fac=function(t){return new(t||r)(k(se),k(xe),k(ue),k(be),k(W))}}static{this.\u0275cmp=V({type:r,selectors:[["app-search"]],standalone:!0,features:[Y],decls:24,vars:5,consts:[[1,"container","mx-auto","p-4","max-w-6xl"],[1,"text-3xl","font-bold","mb-6"],[1,"mb-6",3,"formGroup"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],["appearance","outline",1,"md:col-span-2"],["matInput","","formControlName","title","placeholder","Enter book title","autofocus",""],["matSuffix",""],["appearance","outline"],["matInput","","formControlName","author","placeholder","Enter author name"],[1,"flex","gap-2","mb-4"],["mat-raised-button","","color","primary",3,"click","disabled"],["mat-button","",3,"click","disabled"],[4,"ngIf"],["class","text-center py-8",4,"ngIf"],[1,"text-center","py-8"],[1,"text-6xl","text-gray-400","mb-4"],[1,"text-xl","font-semibold","mb-2"],[1,"text-gray-600","mb-4"],["mat-raised-button","","color","primary"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-3","xl:grid-cols-4","gap-4"],["class","border rounded-lg p-4 hover:shadow-lg transition-shadow",4,"ngFor","ngForOf"],["class","text-center mt-6",4,"ngIf"],[1,"border","rounded-lg","p-4","hover:shadow-lg","transition-shadow"],["loading","lazy",1,"w-full","h-48","object-cover","rounded","mb-3",3,"src","alt"],[1,"font-semibold","text-lg","mb-1","line-clamp-2"],[1,"text-sm","text-gray-600","mb-1"],[1,"text-xs","text-gray-500","mb-3"],["mat-raised-button","","color","primary",1,"w-full",3,"click"],[1,"text-center","mt-6"],["mat-raised-button","",3,"click","disabled"]],template:function(t,i){if(t&1&&(a(0,"div",0)(1,"h1",1),s(2,"Search Books"),n(),a(3,"form",2)(4,"div",3)(5,"mat-form-field",4)(6,"mat-label"),s(7,"Book Title"),n(),L(8,"input",5),a(9,"mat-icon",6),s(10,"search"),n()(),a(11,"mat-form-field",7)(12,"mat-label"),s(13,"Author (optional)"),n(),L(14,"input",8),a(15,"mat-icon",6),s(16,"person"),n()()(),a(17,"div",9)(18,"button",10),B("click",function(){return i.performSearch()}),s(19," Search "),n(),a(20,"button",11),B("click",function(){return i.clearSearch()}),s(21," Clear "),n()()(),v(22,Be,1,0,"app-loading-spinner",12)(23,je,3,2,"div",12),n()),t&2){let o;l(3),p("formGroup",i.searchForm),l(15),p("disabled",i.isLoading||!((o=i.searchForm.get("title"))!=null&&o.value)),l(2),p("disabled",i.isLoading),l(2),p("ngIf",i.isLoading&&i.books.length===0),l(),p("ngIf",!i.isLoading&&i.hasSearched)}},dependencies:[H,z,K,le,oe,ee,ie,re,ne,ae,de,pe,ce,me,ge,fe,Q,J,Z,X,_e,he],styles:["mat-form-field .mat-mdc-text-field-wrapper .mat-mdc-form-field-flex:before{display:none!important}  mat-form-field .mat-mdc-form-field-infix:before{display:none!important}"]})}}return r})();export{at as SearchComponent};
